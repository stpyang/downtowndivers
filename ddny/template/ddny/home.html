{% extends 'ddny/base.html' %}

{% load staticfiles %}

{% block content %}

<link rel="stylesheet" href="{% static 'ddny_calendar/css/calendar.css' %}">
<link rel="stylesheet" href="{% static 'ddny_calendar/css/fullcalendar.css' %}">
<link rel="stylesheet" href="{% static 'ddny_calendar/css/minimal.css' %}">

<title>DDNY Welcome</title>

<div class="page-header">
  <h1>Hello, {{ user.first_name }}!</h1>
</div>

{% if user.member %}
  <div class="row">
    <div class="col-md-12">
    <h2>Upcoming events</h2>
      {% for event in upcoming_events %}
        <div class="row">
          <div class="col-md-4 col-md-offset-1">
          <p>{{ event.dates }}</p>
          </div>
          <div class="col-md-7">
          <p>{{ event.title | linebreaksbr }}</p>
          </div>
        </div>
      {% endfor %}

<!--     <dl class="dl-horizontal">
      {% for event in upcoming_events %}
        <dt>{{ event.dates }}</dt>
        <dd>{{ event.title | linebreaks }}</dd>
      {% endfor %}
    </dl>
 -->    </div>
  </div>

  <div class="centered-text">
    &nbsp;<span id="syncing"></span></p>
  </div>

  <div class="row">
    <div class="col-md-12">
    <div id="calendar"></div>
    </div>
  </div>

{% endif %}

<script src="{% static 'ddny_calendar/js/jquery-2.1.4.min.js' %}"></script>
<script src="{% static 'ddny_calendar/js/moment.js' %}"></script>
<script src="{% static 'ddny_calendar/js/fullcalendar.js' %}"></script>
<script src="{% static 'ddny_calendar/js/icheck.min.js' %}"></script>
<script>
upcoming_event_ids = {{ upcoming_event_ids }}

$(document).ready(function() {
  $('#calendar').fullCalendar({
    allDayDefault: true,
    editable: true,
    eventLimit: true,
    selectable: true,
    selectHelper: true,
    events: {{ event_array | safe }},
    eventDragStart: function() {
      $(".popover.in").remove()
    },
    eventDrop: function(event) {
      $(".popover.in").remove()
      updateEvent(event)
    },
    eventClick: function(event, jsEvent, view) {
      $('.popover.in').remove()
      event_id = parseInt(event._id)
      element = $(this)
      element.popover({
        html: true,
        placement: "top",
        container: "body",
        title: "<textarea id='id_title' rows='2' class='form-control' maxlength='120' required='true'>" + event.title + "</textarea>",
        content: getPopoverContent(event._id, event.start, event.end, upcoming_event_ids.includes(event_id)),
      })
      $("input").iCheck({
        checkboxClass: "icheckbox_minimal",
      })
      element.popover("show")
    },
    select: function(start, end, jsEvent, view, resource) {
      $(".popover.in").remove()
      element = $(jsEvent.toElement)
      element.popover({
        html: true,
        placement: "top",
        container: "body",
        title: "<textarea id='id_title' rows='2' class='form-control'></textarea>",
        content: getPopoverContent("", start, end, false),
      })
      element.popover("show")
    }
  })
})

$(document).keyup(function(e) {
  if (e.keyCode == 27) { // escape key maps to keycode `27`
    $(".popover.in").remove()
  }
})

$(document).on("click", "#save-button", function(e) {
  e.preventDefault()

  // no blank titles allowed
  var title = $("#id_title").val()
  var start = $("#id_start").val()
  var end = $("#id_end").val()
  var show_on_homepage = document.getElementById("id_show_on_homepage").checked
  // TODO(stpyang): how do I move this validation to python or html5?
  if (!title || start > end) {
    return false
  }

  // fetch the event object or create a new one
  var event
  var event_id = $("#id_event_id").val()
  if (event_id) {
    event = $("#calendar").fullCalendar("clientEvents", event_id)[0]
  } else {
    event = Object()
  }

  event.title = title
  var start = $("#id_start").val()
  event.start = moment(start)
  var end = $("#id_end").val()
  event.end = moment(end).add(1, "day")
  event.show_on_homepage = show_on_homepage

  if (event_id) {
    $("#calendar").fullCalendar("updateEvent", event)
    $("#calendar").fullCalendar("rerenderEvents")
    updateEvent(event)
  } else {
    event = $("#calendar").fullCalendar("renderEvent", event)[0]
    createEvent(event)
  }

  $(".popover.in").remove()
})

$(document).on("click", "#remove-button", function(e) {
  e.preventDefault()
  var event_id = $("#id_event_id").val()
  $("#calendar").fullCalendar("removeEvents", event_id)
  deleteEvent(event_id)
  $(".popover.in").remove()
})

$(document).on("click", "#cancel-button", function(e) {
  e.preventDefault()
  $(".popover.in").remove()
})

function getPopoverContent(id, start, end, upcoming) {
  end = end.subtract(1, "seconds")
  content = "<input type='text' class='hidden' value = " + id + " id='id_event_id'></p>"
  content += "<label for='id_start' class='control-label'>Start</label>"
  content += "<input type='text' class='form-control' value = " + start.format('YYYY-MM-DD') + " id='id_start'></p>"
  content += "<br />"
  content += "<label for='id_end' class='control-label'>End</label>"
  content += "<input type='text' class='form-control' value = " + end.format('YYYY-MM-DD') + " id='id_end'></p>"
  content += "<br />"
  content += "<button class='btn btn-primary' id='save-button'>"
  content += "<i class='glyphicons glyphicons-circle-plus'></i>&nbsp;Save"
  content += "</button>"
  if (id) {
    content += "&nbsp;&nbsp;&nbsp;"
    content += "<button class='btn btn-danger' id='remove-button'>"
    content += "<i class='glyphicons glyphicons-bin'></i>&nbsp;Remove"
    content += "</button>"
  } else {
    content += "&nbsp;&nbsp;&nbsp;"
    content += "<button class='btn btn-danger' id='cancel-button'>"
    content += "<i class='glyphicons glyphicons-bin'></i>&nbsp;Cancel"
    content += "</button>"
  }
  content += "<br />"
  content += "<br />"
  if (upcoming) {
    content += "<input class='icheckbox' id='id_show_on_homepage' name='show_on_homepage' type='checkbox' checked />"
  } else {
    content += "<input class='icheckbox' id='id_show_on_homepage' name='show_on_homepage' type='checkbox' />"
  }
  content += "<label for='id_show_on_homepage' class='control-label'>&nbsp;Show on homepage</label>"
  return content
}

function createEvent(event) {
  $("#syncing").html("<i class='fa fa-3x fa-spinner fa-pulse'></i>")
  // NOTE(stpyang): This is a stupid lower-to-upper-case hack
  if (event.show_on_homepage) {
    data_show_on_homepage = "True"
  } else {
    data_show_on_homepage = null
  }
  $.ajax({
    url: "{{ add_event }}",
    type: "POST",
    data: {
      title: event.title,
      start_date: event.start.format("YYYY-MM-DD"),
      end_date: event.end.format("YYYY-MM-DD"),
      show_on_homepage: data_show_on_homepage,
    },
    success: function(json) {
      // let's sync up the event id from gCal
      $("#syncing").html("")
      var id = json["id"]
      event._id = id
      $("#calendar").fullCalendar("updateEvent", event);
      return true
    },
    error: function(xhr, errmsg, err) {
      console.log(xhr)
      console.log(xhr.status + ": " + xhr.responseText)
    }
  })
}

function deleteEvent(event_id) {
  $("#syncing").html("<i class='fa fa-3x fa-spinner fa-pulse'></i>")
  $.ajax({
    url: "{{ delete_event }}",
    type: "POST",
    data: {
      id: event_id,
    },
    success: function(json) {
      $("#syncing").html("")
      return true
    },
    error: function(xhr, errmsg, err) {
      console.log(xhr)
      console.log(xhr.status + ": " + xhr.responseText)
    }
  })
}

function updateEvent(event) {
  // NOTE(stpyang): This is a stupid lower-to-upper-case hack
  if (event.show_on_homepage) {
    data_show_on_homepage = "True"
  } else {
    data_show_on_homepage = null
  }
  $("#syncing").html("<i class='fa fa-3x fa-spinner fa-pulse'></i>")
  $.ajax({
    url: "{{ update_event }}",
    type: "POST",
    data: {
      id: event._id,
      title: event.title,
      start_date: event.start.format("YYYY-MM-DD"),
      end_date: event.end.format("YYYY-MM-DD"),
      show_on_homepage: data_show_on_homepage,
    },
    success: function(json) {
      $("#syncing").html("")
      return true
    },
    error: function(xhr, errmsg, err) {
      console.log(xhr)
      console.log(xhr.status + ": " + xhr.responseText)
    }
  })
}
</script>

{% endblock %}
